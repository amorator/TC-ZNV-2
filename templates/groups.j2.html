{% extends 'base.j2.html' %}
{% block css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/table.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/search.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/groups.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/popup.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/input.css') }}"/>
{% endblock %}

{% block main %}

  <section class="groups-page container-fluid py-3" data-testid="groups-section">
    <table class="groups-page__table files-page__table table table-striped table-hover table-sm align-middle table-colored" id="maintable" role="table" aria-label="Таблица групп" data-testid="groups-table" data-can-manage="{{ 1 if current_user.has('users.manage') else 0 }}" data-server-paging="1">
      <thead class="table__head">
        <tr class="table__head_row" role="row">
          <th class="table__head_item" scope="col">Название</th>
          <th class="table__head_item" scope="col">Описание</th>
          <th class="table__head_item" scope="col">Пользователей</th>
          <th class="table__head_item" scope="col">Создана</th>
        </tr>
      </thead>
      <tbody class="table__body" role="rowgroup">
        <tr id="search" class="table__body_actions">
          <td class="table__body_action" colspan="4">
            <div class="d-flex justify-content-between align-items-center gap-2">
              {% include 'components/searchbar.html' %}
              {% if current_user.has('users.manage') %}
              <button type="button" id="add-group-button" class="btn btn-primary" data-testid="groups-add-open" data-action="add-group" onclick="popupToggle('popup-add');">
                <i class="bi bi-plus-lg"></i> Добавить
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% if groups %}
          {% for group in groups %}
            <tr id="{{ group.id }}" class="table__body_row" role="row" data-id="{{ group.id }}" data-name="{{ group.name }}" data-description="{{ group.description }}" data-is-system="{{ 1 if group.is_system_group(admin_group_name) else 0 }}">
              <td class="table__body_item" role="cell">
                <span class="groups-page__name">{{ group.name }}</span>
                {% if group.is_system_group(admin_group_name) %}
                  <i class="bi bi-shield-fill-check text-danger ms-1" title="Системная группа"></i>
                {% endif %}
              </td>
              <td class="table__body_item" role="cell">{{ group.description or '—' }}</td>
              <td class="table__body_item" role="cell">
                <span class="groups-page__user-count">{{ group.user_count if group.user_count is defined else 0 }}</span>
              </td>
              <td class="table__body_item" role="cell">{{ group.created_at.strftime('%Y-%m-%d %H:%M') if group.created_at else '—' }}</td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
    <div id="groups-pagination" class="files-pagination d-flex justify-content-center py-2"></div>
  </section>

  <div id="popup-add" class="overlay-container" data-testid="groups-modal-add">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-add-title">
      <h1 class="popup__title mb-4" id="popup-add-title">Добавление группы</h1>
      <div class="popup__body">
        <form class="popup__form" id="add" name="add" action="{{ url_for('groups_add') }}" method="post" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="add-name">Название:</label>
            <input id="add-name" type="text" name="name" class="input form-control__control" placeholder="Введите название группы..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="add-description">Описание:</label>
            <textarea id="add-description" name="description" class="input form-control__control" placeholder="Введите описание группы..." autocomplete="one-time-code"></textarea>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" data-testid="groups-add-cancel" onclick="popupToggle('popup-add');">Отмена</button>
            <button type="button" class="btn btn-primary" data-testid="groups-add-submit" onclick="validateForm(this);">Добавить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Context menu for groups table -->
  <div id="context-menu" class="context-menu d-none" data-testid="groups-context-menu">
    <ul class="context-menu__list">
      <li class="context-menu__item" data-action="edit" data-testid="groups-cm-edit">Изменить</li>
      <li class="context-menu__item" data-action="delete" data-testid="groups-cm-delete">Удалить</li>
      <li class="context-menu__separator"></li>
      <li class="context-menu__item" data-action="add" data-testid="groups-cm-add">Добавить</li>
    </ul>
  </div>

  <div id="popup-edit" class="overlay-container" data-testid="groups-modal-edit">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-edit-title">
      <h1 class="popup__title mb-4" id="popup-edit-title">Редактирование группы</h1>
      <div class="popup__body">
        <form class="popup__form" id="edit" name="edit" action="{{ url_for('groups_edit', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-name">Название:</label>
            <input id="edit-name" type="text" name="name" class="input form-control__control" placeholder="Введите название группы..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-description">Описание:</label>
            <textarea id="edit-description" name="description" class="input form-control__control" placeholder="Введите описание группы..." autocomplete="one-time-code"></textarea>
          </div>
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button class="btn btn-secondary" type="button" data-testid="groups-edit-cancel" onclick="popupToggle('popup-edit');">Отмена</button>
            <button class="btn btn-primary" type="button" data-testid="groups-edit-save" onclick="validateForm(this);">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="popup-delete" class="overlay-container" data-testid="groups-modal-delete">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-delete-title">
      <h1 class="popup__title mb-4" id="popup-delete-title">Удалить группу</h1>
      <div class="popup__body">
        <p>Вы действительно хотите удалить группу <b>gname</b>?</p>
        <form class="popup__form" id="delete" name="delete" action="{{ url_for('groups_delete', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" data-testid="groups-delete-cancel" onclick="popupToggle('popup-delete');">Отмена</button>
            <button type="button" class="btn btn-danger" data-testid="groups-delete-confirm" onclick="validateForm(this);">Удалить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}

{% block js %}
<script type="text/javascript">
  // Pass admin group name to JavaScript
  window.adminGroupName = '{{ admin_group_name }}';
</script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/modal-manager.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/context-menu.js') }}" defer="defer"></script>
<script src="{{ url_for('static', filename='js/groups.js') }}" defer="defer"></script>
<script>
// Фокус-ловушка для модальных окон (кастомные попапы Groups)
(function setupGroupsFocusTrap(){
  try {
    function applyTrap(popupEl){
      if (!popupEl) return;
      function onKeyDown(e){
        if (e.key !== 'Tab') return;
        const scope = popupEl;
        const focusables = scope.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
        if (!focusables.length) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
      if (!popupEl._trapBound) {
        popupEl.addEventListener('keydown', onKeyDown);
        popupEl._trapBound = true;
      }
      const firstInput = popupEl.querySelector('input, select, textarea, button.btn-primary');
      if (firstInput) { try { firstInput.focus(); } catch(_) {} }
    }
    const overlays = document.querySelectorAll('.overlay-container .popup');
    overlays.forEach(p => applyTrap(p));
    const mo = new MutationObserver((list)=>{
      list.forEach(m => {
        if (m.type === 'attributes' && (m.attributeName === 'style' || m.attributeName === 'class')){
          const popup = m.target.querySelector && m.target.querySelector('.popup');
          const cs = window.getComputedStyle(m.target);
          if (cs && cs.display !== 'none' && popup) applyTrap(popup);
        }
      });
    });
    document.querySelectorAll('.overlay-container').forEach(oc => {
      mo.observe(oc, { attributes: true, attributeFilter: ['style','class'] });
    });
  } catch(_) {}
})();
</script>
{% endblock %}

