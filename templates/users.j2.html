{% extends 'base.j2.html' %}
{% block css %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/table.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/search.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/users.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/popup.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/select.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/input.css') }}"/>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/components/checkbox.css') }}"/>
{% endblock %}

{% block main %}

  <section class="users-page container-fluid py-3" data-testid="users-section">
    <table class="users-page__table files-page__table table table-striped table-hover table-sm align-middle table-colored" id="maintable" role="table" aria-label="Таблица пользователей" data-testid="users-table" data-can-manage="{{ 1 if current_user.has('users.manage') else 0 }}" data-server-paging="1">
      <thead class="table__head">
        <tr class="table__head_row" role="row">
          <th class="table__head_item" scope="col">Логин</th>
          <th class="table__head_item" scope="col">Имя</th>
          <th class="table__head_item" scope="col">Группа</th>
          <th class="table__head_item" scope="col">Разрешения</th>
          <th class="table__head_item" scope="col">Активен</th>
        </tr>
      </thead>
      <tbody class="table__body" role="rowgroup">
        <tr id="search" class="table__body_actions">
          <td class="table__body_action" colspan="5">
            <div class="d-flex justify-content-between align-items-center gap-2">
              {% include 'components/searchbar.html' %}
              {% if current_user.has('users.manage') %}
              <button type="button" id="add-user-button" class="btn btn-primary" data-testid="users-add-open" data-action="add-user" onclick="popupToggle('popup-add');">
                <i class="bi bi-plus-lg"></i> Добавить
              </button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% if users %}
          {% for user in users %}
            {# Определяем полный доступ с учётом новых прав #}
            {% set admin_cfg = config.get('admin') or {} %}
            {% set admin_group_name = (admin_cfg.get('group') or admin_cfg.get('group_name') or 'Программисты') %}
            {% set user_group_name = groups[user.gid]|default('') %}
            {% set is_admin_group = (user_group_name|lower == admin_group_name|lower) %}
            {% set perm_str = (user.permission_string() or '')|trim %}
            {% set perm_labels = user.permission_labels() %}
            {% set full_legacy = (perm_str == 'aef,a,abcdflm,ab,ab,ab,abcd') %}
            {% set has_z = 'z' in perm_str %}
            {% set is_admin_login = (user.login|lower == 'admin') %}
            {% set is_admin = is_admin_login or user.has('admin.any') or full_legacy or has_z %}
            
            <tr id="{{ user.id }}" class="table__body_row" role="row" data-id="{{ user.id }}" data-enabled="{{ 1 if user.is_enabled() else 0 }}" data-login="{{ user.login }}" data-name="{{ user.name }}" data-gid="{{ user.gid }}" data-groupname="{{ groups[user.gid] }}" data-perm="{{ user.permission_string() }}" data-is-admin="{{ 1 if user.login|lower == 'admin' else 0 }}" data-full-access="{{ 1 if is_admin else 0 }}">
              <td class="table__body_item" role="cell">
                <span class="users-page__login">{{ user.login }}</span>
                {% if user.login|lower == 'admin' %}
                  <i class="bi bi-shield-fill-check text-danger ms-1" title="Администратор системы"></i>
                {% endif %}
              </td>
              <td class="table__body_item" role="cell"><span class="users-page__name" title="Клик — скопировать имя">{{ user.name }}</span></td>
              <td class="table__body_item" role="cell">{{ groups[user.gid] }}</td>
              <td class="table__body_item perms-cell" role="cell">
                {# If admin rights present, show only Admin line and skip others #}
                {% if is_admin %}
                  <div class="perms-cell__item">
                    <span class="perms-cell__cat">Админ</span>: <span class="perms-cell__rights">полный доступ</span>
                  </div>
                {% else %}
                  {# Use this user's permission labels #}
                  {# Build ordered unique list of categories first #}
                  {% set cats = namespace(items=[]) %}
                  {% for label in perm_labels %}
                    {% set parts = label.split(':', 1) %}
                    {% set cat = parts[0].strip() %}
                    {% if not cat.lower().startswith('администратор') %}
                      {% if cat and (cat not in cats.items) %}
                        {% set _ = cats.items.append(cat) %}
                      {% endif %}
                    {% endif %}
                  {% endfor %}

                  {# For each category, collect and normalize rights, then render one line #}
                  {% for cat in cats.items %}
                    {% set rights_ns = namespace(list=[]) %}
                    {% for label in perm_labels %}
                      {% set parts = label.split(':', 1) %}
                      {% if parts and parts[0].strip() == cat and parts|length > 1 %}
                        {% set raw = parts[1].strip() %}
                        {% set raw = raw.replace(';', ',') %}
                        {% set raw = raw.replace('Загрузка/Запись', 'Загрузка') %}
                        {% set raw = raw|lower %}
                        {% for item in raw.split(',') %}
                          {% set it = item.strip() %}
                          {% if it and (it not in rights_ns.list) %}
                            {% set _ = rights_ns.list.append(it) %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    {% endfor %}

                    {# If there are other rights, hide 'просмотр' #}
                    {% set final_ns = namespace(list=[]) %}
                    {% for r in rights_ns.list %}
                      {% if not (rights_ns.list|length > 1 and r == 'просмотр') %}
                        {% set _ = final_ns.list.append(r) %}
                      {% endif %}
                    {% endfor %}

                    <div class="perms-cell__item">
                      <span class="perms-cell__cat">{{ cat }}</span>: <span class="perms-cell__rights">{{ final_ns.list|join(', ') }}</span>
                    </div>
                  {% endfor %}
                {% endif %}
              </td>
              <td class="table__body_item" role="cell" data-enabled="{{ 1 if user.is_enabled() else 0 }}">
                <i class="bi {{ 'bi-toggle-on' if user.is_enabled() else 'bi-toggle-off' }}"></i>
              </td>
            </tr>
          {% endfor %}
        {% endif %}
      </tbody>
    </table>
  </section>

  <div id="users-pagination" class="files-pagination d-flex justify-content-center py-2"></div>

  <div id="popup-add" class="overlay-container" data-testid="users-modal-add">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-add-title">
      <h1 class="popup__title mb-4" id="popup-add-title">Добавление пользователя</h1>
      <div class="popup__body">
        <form class="popup__form" id="add" name="add" action="{{ url_for('users_add') }}" method="post" onsubmit="return false;">
          <div class="perm-layout">
            <div class="perm-layout__left">
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-login">Логин:</label>
                <input id="add-login" type="text" name="login" class="input form-control__control" placeholder="Введите логин..." autocomplete="one-time-code"/>
              </div>
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-name">Имя:</label>
                <input id="add-name" type="text" name="name" class="input form-control__control" placeholder="Введите имя..." autocomplete="one-time-code"/>
              </div>
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-password">Пароль:</label>
                <input id="add-password" type="password" name="password" class="input form-control__control" placeholder="Введите пароль..." autocomplete="one-time-code"/>
              </div>
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-password2">Подтвердите пароль:</label>
                <input id="add-password2" type="password" name="password2" class="input form-control__control" placeholder="Подтвердите пароль..." autocomplete="one-time-code"/>
              </div>
              <div class="popup__form-control form-control">
                <label class="form-control__label" for="add-group">Группа:</label>
                <select id="add-group" name="group" class="select form-control__control">
                  {% for g in groups %}
                    <option class="select__option" value="{{ g }}">
                      {{ groups[g] }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="popup__form-control form-control">
                <label class="checkbox" for="add-enabled">Активен:

                  <input id="add-enabled" class="visually-hidden" type="checkbox" name="enabled" checked="checked"/>

                  <span class="checkbox__flag"></span>
                </label>
              </div>
            </div>
            <div class="perm-layout__right">
              {% set perm_input_id = 'perm-string-add' %}
              {% include 'components/user_permission.html' %}
            </div>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" data-testid="users-add-cancel" onclick="popupToggle('popup-add');">Отмена</button>
            <button type="button" class="btn btn-primary" data-testid="users-add-submit" onclick="validateForm(this);">Добавить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Context menu for users table -->
  <div id="context-menu" class="context-menu d-none" data-testid="users-context-menu">
    <ul class="context-menu__list">
      <li class="context-menu__item" data-action="toggle" data-testid="users-cm-toggle">Включить</li>
      <li class="context-menu__item" data-action="edit" data-testid="users-cm-edit">Изменить</li>
      <li class="context-menu__item" data-action="perm" data-testid="users-cm-perm">Изменить разрешения</li>
      <li class="context-menu__item" data-action="reset" data-testid="users-cm-reset">Сбросить пароль</li>
      <li class="context-menu__item" data-action="delete" data-testid="users-cm-delete">Удалить</li>
      <li class="context-menu__separator"></li>
      <li class="context-menu__item" data-action="add" data-testid="users-cm-add">Добавить</li>
    </ul>
  </div>

  <div id="popup-perm" class="overlay-container" data-testid="users-modal-perm">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-perm-title">
      <h1 class="popup__title mb-4" id="popup-perm-title">Изменение разрешений</h1>
      <div class="popup__body">
        <form class="popup__form" id="perm" name="perm" action="{{ url_for('users_edit', id='0') }}" method="post" onsubmit="return false;">
          {# Скрытые поля, чтобы при сохранении через users_edit не терялись остальные данные #}
          <input type="hidden" name="login" value="" />
          <input type="hidden" name="name" value="" />
          <input type="hidden" name="group" value="" />
          <input type="hidden" name="enabled" value="" />

          <div class="perm-layout">
            <div class="perm-layout__right" style="grid-column: 1 / -1;">
              {% set perm_input_id = 'perm-string-perm' %}
              {% include 'components/user_permission.html' %}
            </div>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button class="btn btn-secondary" type="button" data-testid="users-perm-cancel" onclick="popupToggle('popup-perm');">Отмена</button>
            <button class="btn btn-primary" type="button" data-testid="users-perm-save" onclick="validateForm(this);">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  

  <div id="popup-edit" class="overlay-container" data-testid="users-modal-edit">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-edit-title">
      <h1 class="popup__title mb-4" id="popup-edit-title">Редактирование пользователя</h1>
      <div class="popup__body">
        <form class="popup__form" id="edit" name="edit" action="{{ url_for('users_edit', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-login">Логин:</label>
            <input id="edit-login" type="text" name="login" class="input form-control__control" placeholder="Введите логин..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-name">Имя:</label>
            <input id="edit-name" type="text" name="name" class="input form-control__control" placeholder="Введите имя..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="edit-group">Группа:</label>
            <select id="edit-group" name="group" class="select form-control__control">
              {% for g in groups %}
                <option class="select__option" value="{{ g }}">
                  {{ groups[g] }}
                </option>
              {% endfor %}
            </select>
          </div>
          <div class="popup__form-control form-control">
            <label class="checkbox" for="edit-enabled">Активен:

              <input id="edit-enabled" class="visually-hidden checkbox-active" type="checkbox" name="enabled"/>

              <span class="checkbox__flag"></span>
            </label>
          </div>
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button class="btn btn-secondary" type="button" data-testid="users-edit-cancel" onclick="popupToggle('popup-edit');">Отмена</button>
            <button class="btn btn-primary" type="button" data-testid="users-edit-save" onclick="validateForm(this);">Сохранить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  

  <div id="popup-reset" class="overlay-container" data-testid="users-modal-reset">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-reset-title">
      <h1 class="popup__title mb-4" id="popup-reset-title">Изменение пароля пользователя</h1>
      <div class="popup__body">
        <p>Установить новый пароль для
          <b>uname</b>
        </p>
        <form class="popup__form" id="reset" name="reset" action="{{ url_for('users_reset', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="reset-password">Новый пароль:</label>
            <input id="reset-password" class="input form-control__control" type="password" name="password" placeholder="Введите пароль..." autocomplete="one-time-code"/>
          </div>
          <div class="popup__form-control form-control">
            <label class="form-control__label" for="reset-password2">Подтвердите пароль:</label>
            <input id="reset-password2" class="input form-control__control" type="password" name="password2" placeholder="Подтвердите пароль..." autocomplete="one-time-code"/>
          </div>

          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" data-testid="users-reset-cancel" onclick="popupToggle('popup-reset');">Отмена</button>
            <button class="btn btn-primary" type="button" data-testid="users-reset-save" onclick="validateForm(this);">Изменить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="popup-delete" class="overlay-container" data-testid="users-modal-delete">
    <div class="popup" role="dialog" aria-modal="true" aria-labelledby="popup-delete-title">
      <h1 class="popup__title mb-4" id="popup-delete-title">Удалить пользователя</h1>
      <div class="popup__body">
        <p>Вы действительно хотите удалить пользователя
          <b>uname</b>?</p>
        <form class="popup__form" id="delete" name="delete" action="{{ url_for('users_delete', id='0') }}" method="post" onsubmit="return false;">
          <div class="popup__actions d-flex gap-2 justify-content-between mt-4">
            <button type="button" class="btn btn-secondary" data-testid="users-delete-cancel" onclick="popupToggle('popup-delete');">Отмена</button>
            <button type="button" class="btn btn-danger" data-testid="users-delete-confirm" onclick="validateForm(this);">Удалить</button>
          </div>
        </form>
      </div>
    </div>
  </div>

{% endblock %}

{% block js %}
<script>
  // Pass config values to JavaScript
  window.CONFIG = {
    min_password_length: {{ min_password_length }}
  };
  // Expose admin group name for client-side logic
  (function(){
    try {
      // Prefer server-provided variable
      var ag = '{{ admin_group_name|default("Программисты") }}';
      if (!ag || ag === 'None') { ag = 'Программисты'; }
      window.adminGroupName = String(ag || '').toLowerCase();
    } catch(_) {
      window.adminGroupName = 'программисты';
    }
  })();
</script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/sync.js') }}" defer="defer"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/modal-manager.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='js/scripts/context-menu.js') }}" defer="defer"></script>
<script src="{{ url_for('static', filename='js/users.js') }}" defer="defer"></script>
<script>
// Фокус-ловушка для модальных окон (кастомные попапы Users)
(function setupUsersFocusTrap(){
  try {
    function applyTrap(popupEl){
      if (!popupEl) return;
      function onKeyDown(e){
        if (e.key !== 'Tab') return;
        const scope = popupEl;
        const focusables = scope.querySelectorAll('a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])');
        if (!focusables.length) return;
        const first = focusables[0];
        const last = focusables[focusables.length - 1];
        if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
        else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
      }
      if (!popupEl._trapBound) {
        popupEl.addEventListener('keydown', onKeyDown);
        popupEl._trapBound = true;
      }
      const firstInput = popupEl.querySelector('input, select, textarea, button.btn-primary');
      if (firstInput) { try { firstInput.focus(); } catch(_) {} }
    }
    const overlays = document.querySelectorAll('.overlay-container .popup');
    overlays.forEach(p => applyTrap(p));
    const mo = new MutationObserver((list)=>{
      list.forEach(m => {
        if (m.type === 'attributes' && (m.attributeName === 'style' || m.attributeName === 'class')){
          const popup = m.target.querySelector && m.target.querySelector('.popup');
          const cs = window.getComputedStyle(m.target);
          if (cs && cs.display !== 'none' && popup) applyTrap(popup);
        }
      });
    });
    document.querySelectorAll('.overlay-container').forEach(oc => {
      mo.observe(oc, { attributes: true, attributeFilter: ['style','class'] });
    });
  } catch(_) {}
})();
</script>
{% endblock %}
